{% load static %}

<!-- Styles -->
<style>
.course-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn.buy, .btn.start {
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
}

.btn:hover {
    opacity: 0.9;
}

.courses-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
}

.course-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    width: 300px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.course-info {
    padding: 15px;
    background: #fff;
}
</style>

<!-- Courses Grid -->
<div class="courses-container">
    {% for course in courses %}
    <div class="course-card">
        <div class="course-info">
            <h3>{{ course.title }}</h3>
            <p>{{ course.description|truncatewords:25 }}</p>
            <a href="javascript:void(0);" class="btn start enroll-btn" 
               data-slug="{{ course.slug }}" data-title="{{ course.title }}">
               Enroll Now
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="enrollModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Course Enrollment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modal-body-text"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirm-enroll-btn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<div id="course-data" 
     data-csrf="{{ csrf_token }}" 
     data-authenticated="{{ user.is_authenticated|yesno:'true,false' }}">
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(function(){
    const container = $('#course-data');
    const csrftoken = container.data('csrf');
    const isAuthenticated = container.data('authenticated') === 'true';

    $('.enroll-btn').click(function(){
        const slug = $(this).data('slug');
        const title = $(this).data('title');

        if(isAuthenticated){
            $('#modal-body-text').text(`Do you want to enroll this "${title}" course?`);
            const modal = new bootstrap.Modal(document.getElementById('enrollModal'));
            modal.show();

            $('#confirm-enroll-btn').off('click').on('click', function(){
                $.ajax({
                    url: "{% url 'students:enroll_course' %}",
                    type: 'POST',
                    headers: {'X-CSRFToken': csrftoken},
                    data: { slug: slug },
                    success: function(response){
                        if(response.status=='ok'){
                            modal.hide();
                            alert('Course enrolled successfully!');
                            window.location.href = "{% url 'students:dashboard' %}";
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function(){
                        alert('Something went wrong. Please try again.');
                    }
                });
            });
        } else {
            window.location.href = "{% url 'login' %}?next=" + window.location.pathname;
        }
    });
});


</script>
